(function(){"use strict";let r=null,u=[],t=null,c=null,o=null,l=null;function d(){l&&(clearInterval(l),l=null),c&&(c.close(),c=null),o=null,t&&(t.getTracks().forEach(s=>s.stop()),t=null),r=null,u=[]}async function g(){try{d(),t=await navigator.mediaDevices.getUserMedia({audio:!0}),c=new AudioContext,o=c.createAnalyser(),o.fftSize=256,c.createMediaStreamSource(t).connect(o);const a=new Uint8Array(o.frequencyBinCount);l=setInterval(()=>{if(o){o.getByteTimeDomainData(a);let n=0;for(let m=0;m<a.length;m++)n+=Math.abs((a[m]??128)-128);const i=Math.round(n/a.length);chrome.runtime.sendMessage({action:"audioLevel",level:i})}},50);const e=MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/mp4";r=new MediaRecorder(t,{mimeType:e}),r.ondataavailable=n=>{n.data.size>0&&u.push(n.data)},r.onstop=()=>{const n=new Blob(u,{type:e}),i=new FileReader;i.onload=()=>{chrome.runtime.sendMessage({action:"recordingComplete",audioData:i.result})},i.readAsDataURL(n),d()},r.start(),chrome.runtime.sendMessage({action:"recordingStarted"})}catch(s){const a=s;let e;a.name==="NotAllowedError"?e="Microphone access denied. Please allow microphone access when prompted.":a.name==="NotFoundError"?e="No microphone found. Please connect a microphone.":e=`Microphone error: ${a.message}`,chrome.runtime.sendMessage({action:"recordingError",error:e}),d()}}function f(){r&&r.state==="recording"&&r.stop()}function h(){r&&r.stop(),d(),chrome.runtime.sendMessage({action:"recordingCancelled"})}chrome.runtime.onMessage.addListener((s,a,e)=>{switch(s.action){case"startRecording":g(),e({success:!0});break;case"stopRecording":f(),e({success:!0});break;case"cancelRecording":h(),e({success:!0});break}return!0}),chrome.runtime.sendMessage({action:"offscreenReady"})})();
